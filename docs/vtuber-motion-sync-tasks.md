# VTuber風モーション同期実装タスクリスト

## 実装状況の確認結果

### 実装済みの機能

1. **顔の表情同期**
   - MediaPipe Face Landmarkerによる顔検出 (`src/hooks/useFaceEstimation.ts`)
   - BlendShape値の抽出（目、口、眉など）
   - VRM表情へのマッピング (`src/lib/vrm-expression-mapper.ts`)
   - 視線の制御（LookAt）

2. **体の動き同期**
   - MediaPipe Pose Landmarkerによるポーズ検出 (`src/hooks/usePoseEstimation.ts`)
   - Kalidokitによるリターゲッティング (`src/lib/vrm-retargeter-kalidokit.ts`)
   - 上半身（肩、腕、肘）の動き
   - 背骨（Spine、Chest）の動き

3. **統合コンポーネント**
   - MotionSyncViewer (`src/components/vrm/MotionSyncViewer.tsx`)
   - カメラ管理とリアルタイム更新

### 未実装・改善が必要な機能

## 実装タスクリスト

### フェーズ1: 基本機能の完成（優先度: 高）

#### 1.1 頭の回転の実装
- **現状**: `vrm-retargeter-kalidokit.ts` の211-217行目でコメントアウトされている
- **課題**: 座標系の180度回転問題
- **実装内容**:
  - MediaPipeランドマークから頭の回転を正確に計算
  - VRMの座標系に合わせた変換
  - スムージングの適用

#### 1.2 手の動きの同期
- **現状**: 未実装
- **実装内容**:
  - MediaPipe Hands Landmarkerの統合
  - 手のランドマーク検出フック (`useHandEstimation.ts` の作成)
  - 手の動きをVRMに適用する関数 (`vrm-hand-retargeter.ts` の作成)
  - 指の動きのマッピング（VRMのSpringBoneやBlendShapeに対応）

#### 1.3 表情マッピングの最適化
- **現状**: 重複処理と過剰なデバッグログがある
- **実装内容**:
  - ExpressionManagerとBlendShapeProxyの使い分けを明確化
  - 重複した表情設定の削除
  - デバッグログの整理（環境変数で制御）

### フェーズ2: パフォーマンスと品質向上（優先度: 中）

#### 2.1 スムージングの調整
- **現状**: 各部位で固定値を使用
- **実装内容**:
  - 部位ごとの最適なスムージング係数の調整
  - 動きの速度に応じた動的スムージング
  - カクつきの解消

#### 2.2 エラーハンドリングの強化
- **現状**: エラーを無視している箇所がある
- **実装内容**:
  - BlendShape名の検証とフォールバック
  - 失敗時の適切なログ出力
  - 成功した名前のキャッシュ

#### 2.3 パフォーマンス最適化
- **現状**: 毎フレームのログ出力がある
- **実装内容**:
  - 不要なログの削除
  - オブジェクトプーリングの活用（既に一部実装済み）
  - フレームレートの最適化

### フェーズ3: 高度な機能（優先度: 低）

#### 3.1 カメラキャリブレーション
- **実装内容**:
  - 初期ポーズのキャリブレーション
  - オフセットの自動調整

#### 3.2 微調整UI
- **実装内容**:
  - スムージング係数の調整スライダー
  - 各部位の有効/無効切り替え
  - 感度調整

#### 3.3 複数アバター対応
- **実装内容**:
  - 複数のVRMモデルへの同時適用
  - パフォーマンス最適化

## 実装の優先順位

### 最優先（VTuber風の基本動作に必須）
1. 頭の回転の実装（1.1）
2. 表情マッピングの最適化（1.3）

### 高優先度（自然な動きに重要）
3. 手の動きの同期（1.2）
4. スムージングの調整（2.1）

### 中優先度（品質向上）
5. エラーハンドリングの強化（2.2）
6. パフォーマンス最適化（2.3）

### 低優先度（追加機能）
7. カメラキャリブレーション（3.1）
8. 微調整UI（3.2）

## 技術的な注意点

### 座標系の問題
- MediaPipeとVRMの座標系が異なるため、適切な変換が必要
- 特に頭の回転で180度回転の問題が発生している

### VRMモデルの互換性
- VRM 0.0と1.0の両方に対応する必要がある
- モデルによってBlendShape名が異なる可能性がある

### パフォーマンス
- 毎フレーム（60FPS）で実行されるため、最適化が重要
- オブジェクトの再利用とメモリ管理に注意

## 次のステップ

1. 現在の問題点を特定（頭の回転が動かない、表情が適用されないなど）
2. フェーズ1のタスクから順に実装
3. 各機能の動作確認とデバッグ
4. パフォーマンステストと最適化

## 実装チェックリスト

### フェーズ1
- [ ] 1.1 頭の回転の実装
- [ ] 1.2 手の動きの同期
- [ ] 1.3 表情マッピングの最適化

### フェーズ2
- [ ] 2.1 スムージングの調整
- [ ] 2.2 エラーハンドリングの強化
- [ ] 2.3 パフォーマンス最適化

### フェーズ3
- [ ] 3.1 カメラキャリブレーション
- [ ] 3.2 微調整UI
- [ ] 3.3 複数アバター対応

