# 環境変数設定ガイド

このドキュメントでは、V-Chatアプリケーションに必要な環境変数の設定方法を詳しく説明します。

## 📋 目次

1. [Firebase設定](#firebase設定)
2. [Firebase Admin SDK設定](#firebase-admin-sdk設定)
3. [VRoid Hub設定](#vroid-hub設定)
4. [NextAuth設定](#nextauth設定)
5. [LiveKit設定](#livekit設定)
6. [環境別の設定方法](#環境別の設定方法)

---

## 🔥 Firebase設定

### クライアントサイド用の設定（公開OK）

これらの値は**公開されても問題ありません**（Firebaseセキュリティルールで保護されます）。

#### 取得方法

1. [Firebase Console](https://console.firebase.google.com/) にアクセス
2. プロジェクトを選択
3. 左上の⚙️歯車アイコン → 「**プロジェクトの設定**」
4. 「**全般**」タブで下にスクロール
5. 「**マイアプリ**」セクションで、ウェブアプリを選択（未作成の場合は「**アプリを追加**」）
6. 「**SDK の設定と構成**」に表示される値をコピー

#### 設定する環境変数

```bash
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyD...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project-id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789012
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789012:web:abcdef...
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX
```

---

## 🔐 Firebase Admin SDK設定

### サーバーサイド専用の設定（⚠️ 公開NG）

これらの値は**絶対に公開してはいけません**！

#### 取得方法

1. [Firebase Console](https://console.firebase.google.com/) にアクセス
2. プロジェクトを選択
3. 左上の⚙️歯車アイコン → 「**プロジェクトの設定**」
4. 「**サービスアカウント**」タブをクリック
5. 「**新しい秘密鍵の生成**」ボタンをクリック
6. **警告ダイアログが表示されます** → 「**鍵を生成**」をクリック
7. JSONファイルがダウンロードされます（**安全に保管！**）

#### JSONファイルの例

```json
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "abc123...",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBg...\n-----END PRIVATE KEY-----\n",
  "client_email": "firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com",
  "client_id": "123456789012345678901",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/..."
}
```

#### 設定する環境変数

JSONファイルから以下の3つの値を抽出：

```bash
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBg...\n-----END PRIVATE KEY-----\n"
```

**重要な注意点:**
- `private_key`の値は**ダブルクォートで囲む**
- 改行は`\n`のままコピー（実際の改行に置換しない）
- 先頭と末尾のスペースは削除

---

## 🎭 VRoid Hub設定

### OAuth認証設定

VRoid Hubからユーザーの3Dアバターを取得するための設定です。

#### 取得方法

1. [VRoid Developer Portal](https://developer.vroid.com/) にアクセス
2. VRoid Hubアカウントでログイン
3. 「**アプリケーション**」→「**新規作成**」
4. アプリケーション情報を入力:
   - **名前**: V-Chat（任意）
   - **説明**: V-Chatアプリケーション
   - **リダイレクトURI**:
     - 開発: `http://localhost:3000/api/auth/callback/vroid`
     - 本番: `https://your-domain.com/api/auth/callback/vroid`
   - **スコープ**: `default`にチェック
5. 「**作成**」をクリック
6. **Client ID**と**Client Secret**が表示されます

#### 設定する環境変数

```bash
VROID_CLIENT_ID=your_client_id_here
VROID_CLIENT_SECRET=your_client_secret_here
NEXT_PUBLIC_VROID_CLIENT_ID=your_client_id_here
```

---

## 🔑 NextAuth設定

### 認証システムの設定

#### NEXTAUTH_URL

アプリケーションのベースURLを設定します。

```bash
# 開発環境
NEXTAUTH_URL=http://localhost:3000

# 本番環境
NEXTAUTH_URL=https://your-domain.com
```

#### NEXTAUTH_SECRET

ランダムな秘密鍵を生成します。

**生成方法（ターミナル）:**

```bash
openssl rand -base64 32
```

または、オンラインツール: https://generate-secret.vercel.app/32

```bash
NEXTAUTH_SECRET=生成された文字列をここにペースト
```

#### NEXTAUTH_DEBUG

開発時のみtrueに設定（本番ではfalse）。

```bash
NEXTAUTH_DEBUG=false
```

---

## 🎙️ LiveKit設定

### リアルタイム音声/ビデオ通話機能

#### 取得方法

1. [LiveKit Cloud](https://cloud.livekit.io/) にアクセス
2. アカウント作成/ログイン
3. 「**New Project**」をクリック
4. プロジェクト名を入力して作成
5. 「**Settings**」→「**Keys**」タブ
6. **API Key**と**API Secret**をコピー
7. 「**Settings**」→「**URLs**」タブで**WebSocket URL**をコピー

#### 設定する環境変数

```bash
LIVEKIT_API_KEY=APIxxxxxxxxxxxxxxx
LIVEKIT_API_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NEXT_PUBLIC_LIVEKIT_URL=wss://your-project.livekit.cloud
```

**注意**: Cloud Functionsでも同じ値を設定する必要があります:

```bash
firebase functions:config:set livekit.api_key="APIxxxxxxxxxxxxxxx"
firebase functions:config:set livekit.api_secret="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

---

## 🌍 環境別の設定方法

### ローカル開発環境

1. プロジェクトルートに`.env.local`ファイルを作成
2. `.env.example`の内容をコピー
3. 実際の値を入力

```bash
cp .env.example .env.local
# エディタで .env.local を開いて値を入力
```

**重要**: `.env.local`は絶対にGitにコミットしない！

### Vercel（本番環境）

1. Vercelプロジェクトのダッシュボードを開く
2. 「**Settings**」→「**Environment Variables**」
3. 各環境変数を1つずつ追加:
   - **Key**: 変数名（例: `NEXT_PUBLIC_FIREBASE_API_KEY`）
   - **Value**: 実際の値
   - **Environment**: Production / Preview / Development を選択
4. 「**Save**」をクリック

**ヒント**: 複数の環境変数を一度に貼り付けできます（`.env`形式）

### その他のホスティング

プラットフォームごとの環境変数設定方法:

- **Netlify**: Site settings → Environment variables
- **Railway**: Project Settings → Variables
- **Render**: Environment → Environment Variables

---

## ✅ 設定チェックリスト

すべて設定できたか確認:

- [ ] Firebase クライアントサイド設定（7項目）
- [ ] Firebase Admin SDK設定（3項目）
- [ ] VRoid Hub設定（3項目）
- [ ] NextAuth設定（3項目）
- [ ] LiveKit設定（3項目）
- [ ] `.env.local`ファイルが`.gitignore`に含まれている
- [ ] 本番環境にも同じ変数を設定済み

---

## 🔧 トラブルシューティング

### Firebase Admin SDKエラー

**エラー**: `Failed to parse private key`

**解決策**:
- `FIREBASE_PRIVATE_KEY`がダブルクォートで囲まれているか確認
- 改行が`\n`になっているか確認（実際の改行ではない）
- コピー時に余分なスペースが入っていないか確認

### NextAuthエラー

**エラー**: `NEXTAUTH_URL` is invalid

**解決策**:
- URLにスキーム（`http://`または`https://`）が含まれているか確認
- 末尾にスラッシュ（`/`）がないか確認

### LiveKitエラー

**エラー**: Connection failed

**解決策**:
- `NEXT_PUBLIC_LIVEKIT_URL`が`wss://`で始まっているか確認
- API KeyとSecretが正しいか確認

---

## 📞 サポート

問題が解決しない場合:

1. [プロジェクトのIssue](https://github.com/your-repo/issues)を確認
2. 新しいIssueを作成（**秘密鍵は絶対に貼らない！**）
3. ドキュメントを再確認: `docs/`フォルダ内のREADME

---

**最終更新**: 2025年10月
